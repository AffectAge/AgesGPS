/* =========================================================
   –ù–û–í–û–°–¢–ò (RICHTEXT) + 1 –ù–û–í–û–°–¢–¨ = 1 –Ø–ß–ï–ô–ö–ê
   + –õ–ò–ú–ò–¢ –ü–û –ö–û–õ–ò–ß–ï–°–¢–í–£ –°–¢–†–û–ö (–ë–ï–ó –î–û–ë–ê–í–õ–ï–ù–ò–Ø –°–¢–†–û–ö)
   + –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û–ë –û–ë–†–ï–ó–ö–ï
   Google Apps Script (V8)
   ========================================================= */

/* =======================
   –ù–ê–°–¢–†–û–ô–ö–ò –ù–û–í–û–°–¢–ï–ô
   ======================= */

const NEWS_CELL_LIMIT = 45000;

// –ò–∫–æ–Ω–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
const CATEGORY_ICONS = {
  "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ": "\nüèóÔ∏è",
  "–≠–∫–æ–Ω–æ–º–∏–∫–∞": "\nüí∞",
  "–í–æ–π–Ω–∞": "\n‚öîÔ∏è",
  "–ü–æ–ª–∏—Ç–∏–∫–∞": "\nüèõÔ∏è",
  "–ù–∞—Å–µ–ª–µ–Ω–∏–µ": "\nüë•",
  "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏": "\nüî¨",
  "–û–±—â–µ–µ": "\n‚ÑπÔ∏è"
};

/* =======================
   –ù–û–í–û–°–¢–ò: API
   ======================= */

function ensureNews(data) {
  if (!data || typeof data !== "object") throw new Error("data is required");
  if (!Array.isArray(data.–ù–æ–≤–æ—Å—Ç–∏)) data.–ù–æ–≤–æ—Å—Ç–∏ = [];
}

function initNotifications(data) {
  ensureNews(data);
  data.–ù–æ–≤–æ—Å—Ç–∏ = [];
}

function pushNotice(data, n) {
  ensureNews(data);
  data.–ù–æ–≤–æ—Å—Ç–∏.push(n);
}

/* =======================
   –ù–û–í–û–°–¢–ò: –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø/–î–ï–î–£–ü/–°–û–†–¢
   ======================= */

function normalizeNotification(n) {
  if (typeof n === "string") {
    return {
      category: "–û–±—â–µ–µ",
      sub: "",
      priority: 100,
      parts: [{ text: n }]
    };
  }

  return {
    category: n.category || "–û–±—â–µ–µ",
    sub: n.sub || "",
    priority: (n.priority ?? 100),
    parts: Array.isArray(n.parts) ? n.parts : [{ text: (n.text || "") }]
  };
}

function notificationKey(n) {
  return JSON.stringify({
    category: n.category,
    sub: n.sub,
    parts: n.parts.map(p => ({
      text: p.text || "",
      bold: !!p.bold,
      italic: !!p.italic,
      color: p.color || ""
    }))
  });
}

function collapseNotifications(list) {
  const map = new Map();

  list.forEach(n => {
    const key = notificationKey(n);
    if (!map.has(key)) {
      map.set(key, { ...n, count: 1 });
    } else {
      const stored = map.get(key);
      stored.count++;
      stored.priority = Math.min(stored.priority, n.priority);
    }
  });

  return Array.from(map.values());
}

/* =======================
   RICHTEXT BUILDER
   ======================= */

function buildRichText(parts) {
  const builder = SpreadsheetApp.newRichTextValue();
  let text = "";
  const styles = [];

  parts.forEach(p => {
    const start = text.length;
    text += (p.text || "");
    const end = text.length;
    if (start === end) return;

    let style = SpreadsheetApp.newTextStyle();
    if (p.bold) style = style.setBold(true);
    if (p.italic) style = style.setItalic(true);
    if (p.color) style = style.setForegroundColor(p.color);

    styles.push({ start, end, style: style.build() });
  });

  builder.setText(text);
  styles.forEach(s => builder.setTextStyle(s.start, s.end, s.style));
  return builder.build();
}

function cleanIcon(icon) {
  return String(icon || "‚úé").replace(/\n/g, "");
}

function renderNotificationParts(n) {
  const icon = cleanIcon(CATEGORY_ICONS[n.category]) || "üìå";
  const mult = (n.count || 1) > 1 ? `x${n.count} ` : "";

  return [
    { text: `${mult}${icon} `, bold: true },
    ...n.parts,
    { text: "\n" }
  ];
}

/* =========================================================
   FLUSH: –í–ê–†–ò–ê–ù–¢ A ‚Äî 1 –ù–û–í–û–°–¢–¨ = 1 RICHTEXTVALUE (1 –Ø–ß–ï–ô–ö–ê)
   –í–Ω—É—Ç—Ä–∏ —è—á–µ–π–∫–∏:
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   - –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ sub (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –¢–µ–ª–æ (–∏–∫–æ–Ω–∫–∞ + parts + –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏)
   ========================================================= */

function flushNotifications(data) {
  if (!Array.isArray(data.–ù–æ–≤–æ—Å—Ç–∏)) return;

  const normalized = data.–ù–æ–≤–æ—Å—Ç–∏.map(normalizeNotification);
  const collapsed = collapseNotifications(normalized);

  // –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: category -> sub -> priority -> count
  collapsed.sort((a, b) =>
    (a.category || "–û–±—â–µ–µ").localeCompare(b.category || "–û–±—â–µ–µ") ||
    (a.sub || "").localeCompare(b.sub || "") ||
    a.priority - b.priority ||
    (b.count || 1) - (a.count || 1)
  );

  const cells = [];

  collapsed.forEach(n => {
    const category = n.category || "–û–±—â–µ–µ";
    const sub = n.sub || "";
    const icon = cleanIcon(CATEGORY_ICONS[category]) || "‚úé";

    const parts = [];

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    parts.push({ text: `${icon} ${category}\n`, bold: true });

    // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ sub
    if (sub && sub.trim()) {
      parts.push({ text: `‚å¨ ${sub}\n`, bold: true, italic: true });
    }

    // –¢–µ–ª–æ
    parts.push(...renderNotificationParts(n));

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π —è—á–µ–π–∫–∏
    const rawText = parts.map(p => p.text || "").join("");
    if (rawText.length > NEWS_CELL_LIMIT) {
      const clipped = rawText.slice(0, NEWS_CELL_LIMIT - 1) + "‚Ä¶";
      cells.push(buildRichText([{ text: clipped }]));
    } else {
      cells.push(buildRichText(parts));
    }
  });

  data.–ù–æ–≤–æ—Å—Ç–∏ = cells; // RichTextValue[]
}

/* =========================================================
   –ó–ê–ü–ò–°–¨ –í –õ–ò–°–¢: –ë–ï–ó –î–û–ë–ê–í–õ–ï–ù–ò–Ø –°–¢–†–û–ö
   - –ü–∏—à–µ–º –º–∞–∫—Å–∏–º—É–º —Å—Ç–æ–ª—å–∫–æ –Ω–æ–≤–æ—Å—Ç–µ–π, —Å–∫–æ–ª—å–∫–æ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫ –¥–æ –∫–æ–Ω—Ü–∞ –ª–∏—Å—Ç–∞
   - –ü–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é —á–∏—Å—Ç–∏–º –≤–µ—Å—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ —É–¥–∞–ª—è–ª–∏—Å—å
   - –ü–∏—à–µ–º —Å–ª—É–∂–µ–±–Ω—É—é —Å—Ç—Ä–æ–∫—É (notice) –µ—Å–ª–∏ –æ–±—Ä–µ–∑–∞–ª–∏ –Ω–æ–≤–æ—Å—Ç–∏
   ========================================================= */

/**
 * –ü–∏—à–µ—Ç –Ω–æ–≤–æ—Å—Ç–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –≤ 1 —Å—Ç–æ–ª–±–µ—Ü RichTextValues.
 * –ù–ï –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–∏. –û—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –±–ª–æ–∫ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö capacity.
 *
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet
 * @param {GoogleAppsScript.Spreadsheet.RichTextValue[]} newsCells
 * @param {number} startRow 1-based
 * @param {number} col 1-based
 * @param {number} noticeRow 1-based (–∫—É–¥–∞ –ø–∏—Å–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–±—Ä–µ–∑–∫–µ; 0/<=0 —á—Ç–æ–±—ã –Ω–µ –ø–∏—Å–∞—Ç—å)
 * @param {number} noticeCol 1-based
 */
function writeNewsToSheetNoResizeWithNotice_(sheet, newsCells, startRow, col, noticeRow, noticeCol) {
  newsCells = Array.isArray(newsCells) ? newsCells : [];

  const maxRows = sheet.getMaxRows();
  const capacity = Math.max(0, maxRows - startRow + 1); // –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥ –Ω–æ–≤–æ—Å—Ç–∏
  const total = newsCells.length;
  const written = Math.min(total, capacity);
  const cut = Math.max(0, total - written);

  // 1) –û–±–Ω–æ–≤–ª—è–µ–º notice (–≤—Å–µ–≥–¥–∞, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–π –∞–ª–µ—Ä—Ç –ø—Ä–æ–ø–∞–¥–∞–ª)
  if (noticeRow && noticeRow > 0 && noticeCol && noticeCol > 0) {
    if (cut > 0) {
      const rt = buildRichText([
        { text: "‚õî –ù–æ–≤–æ—Å—Ç–∏ –æ–±—Ä–µ–∑–∞–Ω—ã\n", bold: true },
        { text: `–ù–µ –ø–æ–º–µ—Å—Ç–∏–ª–æ—Å—å: ${cut}\n` },
        { text: `–ó–∞–ø–∏—Å–∞–Ω–æ: ${written} –∏–∑ ${total}\n` }
      ]);
      sheet.getRange(noticeRow, noticeCol).setRichTextValue(rt);
    } else {
      sheet.getRange(noticeRow, noticeCol).clearContent();
    }
  }

  // –ï—Å–ª–∏ –º–µ—Å—Ç–∞ –ø–æ–¥ –Ω–æ–≤–æ—Å—Ç–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç ‚Äî —Ç–æ–ª—å–∫–æ notice
  if (capacity === 0) return { written: 0, cut };

  // 2) –ß–∏—Å—Ç–∏–º –≤–µ—Å—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–ª–æ–∫ (—É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ "–∫–∞–∫ —Ä–∞–Ω—å—à–µ")
  //    –í–∞–∂–Ω–æ: —á–∏—Å—Ç–∏–º –∏–º–µ–Ω–Ω–æ capacity —Å—Ç—Ä–æ–∫, –∞ –Ω–µ –≤–µ—Å—å —Å—Ç–æ–ª–±–µ—Ü.
  sheet.getRange(startRow, col, capacity, 1).clearContent();

  // 3) –ü–∏—à–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –ø–æ–º–µ—â–∞–µ—Ç—Å—è
  if (written > 0) {
    const values2d = newsCells.slice(0, written).map(rt => [rt]);
    sheet.getRange(startRow, col, written, 1).setRichTextValues(values2d);
  }

  return { written, cut };
}

/* =========================================================
   –ü–†–ò–ú–ï–† –í–´–ó–û–í–ê (–≤—Å—Ç—Ä–æ–π –≤ —Ç–≤–æ–π runGame/nextTurn)
   ========================================================= */

/**
 * –ü—Ä–∏–º–µ—Ä: –≤—ã–≤–æ–¥ –≤ –ª–∏—Å—Ç "–ù–æ–≤–æ—Å—Ç–∏"
 * - notice: A1
 * - –Ω–æ–≤–æ—Å—Ç–∏: A2 –≤–Ω–∏–∑
 */
function outputNewsToSheetExample_(data) {
  const ss = SpreadsheetApp.getActive();
  const sheet = ss.getSheetByName("–ù–æ–≤–æ—Å—Ç–∏") || ss.insertSheet("–ù–æ–≤–æ—Å—Ç–∏");

  // –°–æ–±—Ä–∞–ª–∏ data.–ù–æ–≤–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ pushNotice(...) –≥–¥–µ-—Ç–æ –≤ –ª–æ–≥–∏–∫–µ —Ö–æ–¥–∞
  flushNotifications(data); // —Ç–µ–ø–µ—Ä—å data.–ù–æ–≤–æ—Å—Ç–∏ = RichTextValue[]

  // –ü–∏—à–µ–º –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫
  writeNewsToSheetNoResizeWithNotice_(sheet, data.–ù–æ–≤–æ—Å—Ç–∏, 2, 1, 1, 1);
}
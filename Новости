const NEWS_CELL_LIMIT = 45000;

const CATEGORY_ICONS = {
  "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ": "\nüèóÔ∏è",
  "–≠–∫–æ–Ω–æ–º–∏–∫–∞": "\nüí∞",
  "–í–æ–π–Ω–∞": "\n‚öîÔ∏è",
  "–ü–æ–ª–∏—Ç–∏–∫–∞": "\nüèõÔ∏è",
  "–ù–∞—Å–µ–ª–µ–Ω–∏–µ": "\nüë•",
  "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏": "\nüî¨",
  "–û–±—â–µ–µ": "\n‚ÑπÔ∏è"
};

function initNotifications(data) {
  data.–ù–æ–≤–æ—Å—Ç–∏ = [];
}

function normalizeNotification(n) {
  if (typeof n === "string") {
    return {
      category: "–û–±—â–µ–µ",
      sub: "",
      priority: 100,
      parts: [{ text: n }]
    };
  }

  return {
    category: n.category || "–û–±—â–µ–µ",
    sub: n.sub || "",
    priority: n.priority ?? 100,
    parts: n.parts || [{ text: n.text || "" }]
  };
}

function notificationKey(n) {
  return JSON.stringify({
    category: n.category,
    sub: n.sub,
    parts: n.parts.map(p => ({
      text: p.text || "",
      bold: !!p.bold,
      italic: !!p.italic,
      color: p.color || ""
    }))
  });
}

function collapseNotifications(list) {
  const map = new Map();

  list.forEach(n => {
    const key = notificationKey(n);

    if (!map.has(key)) {
      map.set(key, { ...n, count: 1 });
    } else {
      const stored = map.get(key);
      stored.count++;
      stored.priority = Math.min(stored.priority, n.priority);
    }
  });

  return Array.from(map.values());
}

function groupByCategory(list) {
  const groups = {};
  list.forEach(n => {
    if (!groups[n.category]) groups[n.category] = [];
    groups[n.category].push(n);
  });
  return groups;
}

function sortCategory(list) {
  return list.sort((a, b) =>
    a.priority - b.priority ||
    (b.count || 1) - (a.count || 1)
  );
}

function buildRichText(parts) {
  const builder = SpreadsheetApp.newRichTextValue();
  let text = "";
  const styles = [];

  parts.forEach(p => {
    const start = text.length;
    text += p.text || "";
    const end = text.length;

    if (start === end) return;

    let style = SpreadsheetApp.newTextStyle();

    if (p.bold) style = style.setBold(true);
    if (p.italic) style = style.setItalic(true);
    if (p.color) style = style.setForegroundColor(p.color);

    styles.push({ start, end, style: style.build() });
  });

  builder.setText(text);
  styles.forEach(s => builder.setTextStyle(s.start, s.end, s.style));

  return builder.build();
}

function renderNotification(n) {
  const icon = CATEGORY_ICONS[n.category] || "üìå";
  const mult = n.count > 1 ? `üì∞x${n.count} ` : "";

  const header = `${mult}${icon} `;
  const parts = [{ text: header }, ...n.parts];

  return buildRichText(parts);
}

function flushNotifications(data) {
  if (!Array.isArray(data.–ù–æ–≤–æ—Å—Ç–∏)) return;

  const normalized = data.–ù–æ–≤–æ—Å—Ç–∏.map(normalizeNotification);
  const collapsed = collapseNotifications(normalized);
  const grouped = groupByCategory(collapsed);

  const cells = [];
  let currentText = "";
  let currentParts = [];

  Object.keys(grouped).sort().forEach(category => {
    const icon = CATEGORY_ICONS[category] || "üìå";
    const header = `\n${icon} ${category}\n`;

    if (currentText.length + header.length > NEWS_CELL_LIMIT) {
      cells.push(buildRichText(currentParts));
      currentText = "";
      currentParts = [];
    }

    currentText += header;
    currentParts.push({ text: header, bold: true });

    sortCategory(grouped[category]).forEach(n => {
      const rendered = renderNotification(n);
      const text = rendered.getText() + "\n";

      if (currentText.length + text.length > NEWS_CELL_LIMIT) {
        cells.push(buildRichText(currentParts));
        currentText = text;
        currentParts = [{ text }];
      } else {
        currentText += text;
        currentParts.push({ text });
      }
    });
  });

  if (currentText.trim()) {
    cells.push(buildRichText(currentParts));
  }

  data.–ù–æ–≤–æ—Å—Ç–∏ = cells;
}

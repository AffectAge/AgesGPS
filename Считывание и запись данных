/***************/
/* JSON helpers */
/***************/
function safeParse(v) {
  // ÐŸÑƒÑÑ‚Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
  if (v === "" || v == null || v === undefined) return null;

  // Ð£Ð¶Ðµ Ð¾Ð±ÑŠÐµÐºÑ‚ â€” Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ
  if (typeof v === "object") return v;

  // ÐÐµ ÑÑ‚Ñ€Ð¾ÐºÐ° â€” Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
  if (typeof v !== "string") return v;

  const trimmed = v.trim();

  // ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð¢ÐžÐ›Ð¬ÐšÐž ÐµÑÐ»Ð¸ ÑÑ‚Ñ€Ð¾ÐºÐ° ÑÐ²Ð½Ð¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ { Ð¸Ð»Ð¸ [
  if (trimmed.startsWith("{") || trimmed.startsWith("[")) {
    try {
      return JSON.parse(trimmed);
    } catch (e) {
      // ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð»Ñ‘Ð³ÐºÑƒÑŽ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÑƒ "Ð³Ñ€ÑÐ·Ð½Ð¾Ð³Ð¾" JSON
      try {
        const cleaned = trimmed
          .replace(/'/g, '"')                    // Ð¾Ð´Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ¸ â†’ Ð´Ð²Ð¾Ð¹Ð½Ñ‹Ðµ
          .replace(/,\s*([}\]])/g, '$1')          // Ð»Ð¸ÑˆÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑÑ‚Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼
          .replace(/(\w+):/g, '"$1":');           // ÐºÐ»ÑŽÑ‡Ð¸ Ð±ÐµÐ· ÐºÐ°Ð²Ñ‹Ñ‡ÐµÐº â†’ Ñ ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ°Ð¼Ð¸

        return JSON.parse(cleaned);
      } catch (e2) {
        console.warn('âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐ¸Ñ‚ÑŒ JSON Ð´Ð°Ð¶Ðµ Ð¿Ð¾ÑÐ»Ðµ Ñ‡Ð¸ÑÑ‚ÐºÐ¸:', trimmed.substring(0, 100) + '...');
        return trimmed; // Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½Ðµ Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ»Ð¸ÑÑŒ
      }
    }
  } else {
    // ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚, Ð½Ð¾Ð²Ð¾ÑÑ‚Ð¸ Ð¸ Ñ‚.Ð¿. â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÐºÐ°Ðº ÑÑ‚Ñ€Ð¾ÐºÑƒ
    return trimmed;
  }
}

function safeStringify(v) {
  if (v == null) return "";

  // Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¿Ñ€Ð¸Ð¼Ð¸Ñ‚Ð¸Ð² (ÑÑ‚Ñ€Ð¾ÐºÐ°, Ñ‡Ð¸ÑÐ»Ð¾, boolean) â€” Ð½Ðµ Ð¾Ð±Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð² JSON
  if (typeof v !== "object") return String(v);

  // ÐžÐ±ÑŠÐµÐºÑ‚Ñ‹ Ð¸ Ð¼Ð°ÑÑÐ¸Ð²Ñ‹ â€” Ð² JSON
  return JSON.stringify(v);
}

/********************/
/* RANGE READ/WRITE */
/********************/
function readNamedRange(name) {
  console.log(`ðŸ“¥ Ð§Ñ‚ÐµÐ½Ð¸Ðµ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð°: ${name}`);

  const ss = SpreadsheetApp.getActive();
  const range = ss.getRangeByName(name);
  if (!range) throw new Error(`Ð”Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ '${name}' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½`);

  const values = range.getValues();
  const headers = values[0].map(String);
  const data = {};

  headers.forEach(h => data[h] = []);

  for (let r = 1; r < values.length; r++) {
    headers.forEach((h, c) => {
      data[h].push(safeParse(values[r][c]));
    });
  }

  console.log(`âœ… Ð”Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ '${name}' Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½`, data);
  return { name, range, headers, data };
}

function writeNamedRange(ctx) {
  console.log(`ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð°: ${ctx.name}`);

  const { range, headers, data } = ctx;
  const rows = range.getNumRows();
  const cols = headers.length;

  const out = Array.from({ length: rows }, () => Array(cols).fill(""));
  const rich = Array.from({ length: rows }, () => Array(cols).fill(null));

  headers.forEach((h, c) => out[0][c] = h);

  for (let r = 1; r < rows; r++) {
    headers.forEach((h, c) => {
      const v = data[h][r - 1];

      if (v && typeof v.getText === "function") {
        rich[r][c] = v;        // RichText
        out[r][c] = v.getText();
      } else {
        out[r][c] = safeStringify(v);
      }
    });
  }

  range.setValues(out);

  // ðŸ”” Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ RichText Ð¿Ð¾Ð²ÐµÑ€Ñ…
  rich.forEach((row, r) => {
    row.forEach((cell, c) => {
      if (cell) {
        range.getCell(r + 1, c + 1).setRichTextValue(cell);
      }
    });
  });
}

/********************/
/* MAIN GAME ENGINE */
/********************/
function runGame(rangeNames, ...logicFunctions) {
  console.log('ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ñ…Ð¾Ð´Ð°');

  const contexts = {};
  let data = {};

  // 1ï¸âƒ£ Ð§Ñ‚ÐµÐ½Ð¸Ðµ Ð¸ ÐžÐ‘ÐªÐ•Ð”Ð˜ÐÐ•ÐÐ˜Ð•
  rangeNames.forEach(name => {
    console.log(`ðŸ“¥ Ð§Ñ‚ÐµÐ½Ð¸Ðµ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð°: ${name}`);
    const ctx = readNamedRange(name);
    contexts[name] = ctx;

    Object.keys(ctx.data).forEach(column => {
      if (data[column]) {
        console.warn(`âš ï¸ ÐšÐ¾Ð»Ð¾Ð½ÐºÐ° "${column}" ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ â€” Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑŒ`);
      }
      data[column] = ctx.data[column];
    });
  });

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð½Ð¾Ð²Ð¾ÑÑ‚ÐµÐ¹
initNotifications(data);

  // 2ï¸âƒ£ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð»Ð¾Ð³Ð¸ÐºÐ¸
  logicFunctions.forEach(fn => {
    console.log(`â–¶ï¸ ${fn.name}`);
    data = fn(data) || data;
  });

// Ð—Ð°Ð¿Ð¸ÑÑŒ Ð½Ð¾Ð²Ð¾ÑÑ‚ÐµÐ¹
flushNotifications(data);

  // 3ï¸âƒ£ Ð Ð°Ð·Ð±Ð¾Ñ€ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð¿Ð¾ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð°Ð¼
  rangeNames.forEach(name => {
    const ctx = contexts[name];
    const updated = {};

    Object.keys(ctx.data).forEach(column => {
      updated[column] = data[column];
    });

    ctx.data = updated;
    writeNamedRange(ctx);
  });

  console.log('âœ… Ð¥Ð¾Ð´ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½');
}
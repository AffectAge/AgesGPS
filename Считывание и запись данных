/***************/
/* JSON helpers */
/***************/
function safeParse(v) {
  if (v === "" || v == null) return null;
  if (typeof v === "object") return v;

  try {
    return JSON.parse(v);
  } catch {
    try {
      return JSON.parse(
        v.replace(/'/g, '"')
         .replace(/,(\s*[}\]])/g, '$1')
      );
    } catch {
      console.warn('âŒ JSON parse failed:', v);
      return null;
    }
  }
}

function safeStringify(v) {
  return v == null ? "" : JSON.stringify(v);
}

/********************/
/* RANGE READ/WRITE */
/********************/
function readNamedRange(name) {
  console.log(`ðŸ“¥ Ð§Ñ‚ÐµÐ½Ð¸Ðµ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð°: ${name}`);

  const ss = SpreadsheetApp.getActive();
  const range = ss.getRangeByName(name);
  if (!range) throw new Error(`Ð”Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ '${name}' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½`);

  const values = range.getValues();
  const headers = values[0].map(String);
  const data = {};

  headers.forEach(h => data[h] = []);

  for (let r = 1; r < values.length; r++) {
    headers.forEach((h, c) => {
      data[h].push(safeParse(values[r][c]));
    });
  }

  console.log(`âœ… Ð”Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ '${name}' Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½`, data);
  return { name, range, headers, data };
}

function writeNamedRange(ctx) {
  console.log(`ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð°: ${ctx.name}`);

  const { range, headers, data } = ctx;
  const rows = range.getNumRows();
  const cols = headers.length;

  const out = Array.from({ length: rows }, () => Array(cols).fill(""));

  headers.forEach((h, c) => out[0][c] = h);

  for (let r = 1; r < rows; r++) {
    headers.forEach((h, c) => {
      out[r][c] = safeStringify(data[h][r - 1]);
    });
  }

  range.setValues(out);
}

/********************/
/* MAIN GAME ENGINE */
/********************/
function runGame(rangeNames, ...logicFunctions) {
  console.log('ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ñ…Ð¾Ð´Ð°');

  const contexts = {};
  let data = {};

  // 1ï¸âƒ£ Ð§Ñ‚ÐµÐ½Ð¸Ðµ Ð¸ ÐžÐ‘ÐªÐ•Ð”Ð˜ÐÐ•ÐÐ˜Ð•
  rangeNames.forEach(name => {
    console.log(`ðŸ“¥ Ð§Ñ‚ÐµÐ½Ð¸Ðµ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð°: ${name}`);
    const ctx = readNamedRange(name);
    contexts[name] = ctx;

    Object.keys(ctx.data).forEach(column => {
      if (data[column]) {
        console.warn(`âš ï¸ ÐšÐ¾Ð»Ð¾Ð½ÐºÐ° "${column}" ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ â€” Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑŒ`);
      }
      data[column] = ctx.data[column];
    });
  });

  // 2ï¸âƒ£ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð»Ð¾Ð³Ð¸ÐºÐ¸
  logicFunctions.forEach(fn => {
    console.log(`â–¶ï¸ ${fn.name}`);
    data = fn(data) || data;
  });

  // 3ï¸âƒ£ Ð Ð°Ð·Ð±Ð¾Ñ€ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð¿Ð¾ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð°Ð¼
  rangeNames.forEach(name => {
    const ctx = contexts[name];
    const updated = {};

    Object.keys(ctx.data).forEach(column => {
      updated[column] = data[column];
    });

    ctx.data = updated;
    writeNamedRange(ctx);
  });

  console.log('âœ… Ð¥Ð¾Ð´ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½');
}